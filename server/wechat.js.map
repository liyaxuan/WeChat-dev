{"version":3,"sources":["wechat.es6.js"],"names":[],"mappings":"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","file":"wechat.js","sourcesContent":["let http = require('http');\r\nlet https = require('https');\r\nlet agent = require('superagent');\r\nlet xmlParser = require('express-xml-bodyparser');\r\nlet xml2js = require('xml2js');\r\n\r\nexport function wechat(app) {\r\n\tapp.use(xmlParser({ normalizeTags: false }));\r\n\r\n\tapp.get('/wechat', (req, res) => {\r\n\t\tres.send(req.query.echostr);\r\n\t});\r\n\r\n\tapp.post('/wechat', (req, res) => {\r\n\t\tlet xml = req.body.xml;\r\n\r\n\t\tlet builder = new xml2js.Builder({\r\n\t\t\trootName: 'xml',\r\n\t\t\theadless: true,\r\n\t\t\tcdata: true\r\n\t\t});\r\n\r\n\t\tlet obj = {\r\n\t\t\tToUserName: xml.FromUserName,\r\n\t\t\tFromUserName: xml.ToUserName,\r\n\t\t\tCreateTime: new Date(),\r\n\t\t\tMsgType: 'text',\r\n\t\t\tContent: 'Hello'\r\n\t\t};\r\n\t\t\r\n\t\tconsole.log(builder.buildObject(obj));\r\n\t\tres.send(builder.buildObject(obj));\r\n\t});\r\n};\r\n\r\nexport function getAccessToken() {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tagent.get('https://api.weixin.qq.com/cgi-bin/token').query({\r\n\t\t\tgrant_type: 'client_credential',\r\n\t\t\tappid: 'wx7f926eda7e850371',\r\n\t\t\tsecret: 'de4befe2f34c79c632fbfe084af74102'\r\n\t\t}).end((err, res) => {\r\n\t\t\tlet resMsg = JSON.parse(res.text);\r\n\t\t\tresMsg.errcode ? reject(resMsg) : resolve(resMsg.access_token);\r\n\t\t});\r\n\t});\r\n};\r\n\r\nfunction uploadImage({ access_token, filename }) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tagent.post('https://api.weixin.qq.com/cgi-bin/media/upload').query({\r\n\t\t\taccess_token: access_token,\r\n\t\t\ttype: 'image'\r\n\t\t}).attach('media', `../upload/${filename}`).end((err, res) => {\r\n\t\t\tlet resMsg = JSON.parse(res.text);\r\n\t\t\tresMsg.errcode ? reject(resMsg) : resolve({ media_id: resMsg.media_id, access_token: access_token});\r\n\t\t});\r\n\t});\t\t\r\n};\r\n\r\nlet sendMessage = function ({ access_token, touser, type, content }) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tlet reqBody = { touser: touser, msgtype: type};\r\n\t\tif(type == 'text')\r\n\t\t\treqBody[type] = { content: content }\r\n\t\telse if(type == 'image')\r\n\t\t\treqBody[type] = { media_id: content }\r\n\r\n\t\tagent.post('https://api.weixin.qq.com/cgi-bin/message/custom/send').query({\r\n\t\t\taccess_token: access_token\r\n\t\t}).send(reqBody).end((err, res) => {\r\n\t\t\tlet resMsg = JSON.parse(res.text);\r\n\t\t\tconsole.log(`sendMessage: ${resMsg}`);\r\n\t\t\tresMsg.errcode ? reject(resMsg) : resolve(resMsg, access_token);\r\n\t\t})\r\n\t});\r\n};\r\n\r\n// getAccessToken().then((access_token) => {\r\n// \treturn uploadImage({\r\n// \t\taccess_token: access_token,\r\n// \t\tfilename: '1.jpg'\r\n// \t});\r\n// }, (errMsg) => { console.log(errMsg); })\r\n// .then(({ media_id, access_token }) => {\r\n// \tconsole.log(access_token);\r\n// \treturn sendMessage({\r\n// \t\taccess_token: access_token,\r\n// \t\tcontent: media_id,\r\n// \t\ttouser: 'o0kZNwNDAfCw3lz_7ELS34TGyZzU',\r\n// \t\ttype: 'image'\r\n// \t});\r\n// }, (errMsg) => { console.log(errMsg); }).then((resMsg, access_token) => {\r\n\t\r\n// });"],"sourceRoot":"/source/"}